
//var trendSummary = [{"trendSpecies":"AMGO","trendGuild":"PlantSeed","trendTrend":-0.2822,"trendLCI":-0.4231,"trendUCI":-0.1487,"trendMedian":-0.2815,"trendStatSig":true,"trendPropInSupport":1,"trendYears":"1989-2023"},{"trendSpecies":"AMRE","trendGuild":"Invertebrate","trendTrend":-0.0018,"trendLCI":-0.1402,"trendUCI":0.1461,"trendMedian":-0.0089,"trendStatSig":false,"trendPropInSupport":0.5404,"trendYears":"1989-2023"},{"trendSpecies":"AMRO","trendGuild":"Omnivore","trendTrend":0.0407,"trendLCI":-0.0473,"trendUCI":0.1305,"trendMedian":0.0365,"trendStatSig":false,"trendPropInSupport":0.76,"trendYears":"1989-2023"},{"trendSpecies":"BAOR","trendGuild":"Invertebrate","trendTrend":-0.2416,"trendLCI":-0.5329,"trendUCI":0.2329,"trendMedian":-0.3042,"trendStatSig":false,"trendPropInSupport":0.8388,"trendYears":"1989-2023"},{"trendSpecies":"BAWW","trendGuild":"Invertebrate","trendTrend":0.065,"trendLCI":-0.0489,"trendUCI":0.2048,"trendMedian":0.0573,"trendStatSig":false,"trendPropInSupport":0.8179,"trendYears":"1989-2023"},{"trendSpecies":"BCCH","trendGuild":"Invertebrate","trendTrend":0.0362,"trendLCI":-0.0709,"trendUCI":0.1455,"trendMedian":0.0333,"trendStatSig":false,"trendPropInSupport":0.6596,"trendYears":"1989-2023"},{"trendSpecies":"BHCO","trendGuild":"PlantSeed","trendTrend":-0.1696,"trendLCI":-0.4341,"trendUCI":0.1028,"trendMedian":-0.1691,"trendStatSig":false,"trendPropInSupport":0.8971,"trendYears":"1989-2023"},{"trendSpecies":"BHVI","trendGuild":"Invertebrate","trendTrend":0.0594,"trendLCI":-0.0371,"trendUCI":0.1827,"trendMedian":0.0435,"trendStatSig":false,"trendPropInSupport":0.8254,"trendYears":"1989-2023"},{"trendSpecies":"BLBW","trendGuild":"Invertebrate","trendTrend":-0.0358,"trendLCI":-0.1519,"trendUCI":0.09,"trendMedian":-0.0435,"trendStatSig":false,"trendPropInSupport":0.6679,"trendYears":"1989-2023"},{"trendSpecies":"BLJA","trendGuild":"Omnivore","trendTrend":0.0855,"trendLCI":0.0168,"trendUCI":0.1584,"trendMedian":0.0847,"trendStatSig":true,"trendPropInSupport":0.9979,"trendYears":"1989-2023"},{"trendSpecies":"BRCR","trendGuild":"Invertebrate","trendTrend":0.0157,"trendLCI":-0.1137,"trendUCI":0.1221,"trendMedian":0.0211,"trendStatSig":false,"trendPropInSupport":0.6317,"trendYears":"1989-2023"},{"trendSpecies":"BTBW","trendGuild":"Invertebrate","trendTrend":0.0628,"trendLCI":-0.0129,"trendUCI":0.1277,"trendMedian":0.0681,"trendStatSig":false,"trendPropInSupport":0.9342,"trendYears":"1989-2023"},{"trendSpecies":"BTNW","trendGuild":"Invertebrate","trendTrend":0.0951,"trendLCI":0.0295,"trendUCI":0.1501,"trendMedian":0.0983,"trendStatSig":true,"trendPropInSupport":0.9992,"trendYears":"1989-2023"},{"trendSpecies":"CAWA","trendGuild":"Invertebrate","trendTrend":-0.0943,"trendLCI":-0.2559,"trendUCI":0.0539,"trendMedian":-0.0887,"trendStatSig":false,"trendPropInSupport":0.8721,"trendYears":"1989-2023"},{"trendSpecies":"CEDW","trendGuild":"FruiNect","trendTrend":-0.1,"trendLCI":-0.2882,"trendUCI":0.0632,"trendMedian":-0.0871,"trendStatSig":false,"trendPropInSupport":0.8558,"trendYears":"1989-2023"},{"trendSpecies":"CHIP","trendGuild":"Omnivore","trendTrend":-0.1,"trendLCI":-0.2076,"trendUCI":0.0169,"trendMedian":-0.1032,"trendStatSig":false,"trendPropInSupport":0.9475,"trendYears":"1989-2023"},{"trendSpecies":"COYE","trendGuild":"Invertebrate","trendTrend":-0.1023,"trendLCI":-0.323,"trendUCI":0.0721,"trendMedian":-0.0894,"trendStatSig":false,"trendPropInSupport":0.8379,"trendYears":"1989-2023"},{"trendSpecies":"CSWA","trendGuild":"Invertebrate","trendTrend":-0.3158,"trendLCI":-0.793,"trendUCI":0.1439,"trendMedian":-0.3687,"trendStatSig":false,"trendPropInSupport":0.7496,"trendYears":"1989-2023"},{"trendSpecies":"DOWO","trendGuild":"Invertebrate","trendTrend":-0.0408,"trendLCI":-0.1987,"trendUCI":0.0744,"trendMedian":-0.0166,"trendStatSig":false,"trendPropInSupport":0.5904,"trendYears":"1989-2023"},{"trendSpecies":"EAWP","trendGuild":"Invertebrate","trendTrend":0.0468,"trendLCI":-0.0153,"trendUCI":0.1061,"trendMedian":0.0464,"trendStatSig":false,"trendPropInSupport":0.9433,"trendYears":"1989-2023"},{"trendSpecies":"GCFL","trendGuild":"Invertebrate","trendTrend":-0.0324,"trendLCI":-0.1255,"trendUCI":0.0618,"trendMedian":-0.0324,"trendStatSig":false,"trendPropInSupport":0.7471,"trendYears":"1989-2023"},{"trendSpecies":"GCKI","trendGuild":"Invertebrate","trendTrend":-0.0759,"trendLCI":-0.3117,"trendUCI":0.125,"trendMedian":-0.0664,"trendStatSig":false,"trendPropInSupport":0.7192,"trendYears":"1989-2023"},{"trendSpecies":"GRCA","trendGuild":"Invertebrate","trendTrend":-0.1236,"trendLCI":-0.6535,"trendUCI":0.2528,"trendMedian":-0.1136,"trendStatSig":false,"trendPropInSupport":0.6383,"trendYears":"1989-2023"},{"trendSpecies":"HAWO","trendGuild":"Invertebrate","trendTrend":-0.091,"trendLCI":-0.2302,"trendUCI":0.0582,"trendMedian":-0.1007,"trendStatSig":false,"trendPropInSupport":0.8079,"trendYears":"1989-2023"},{"trendSpecies":"HETH","trendGuild":"Invertebrate","trendTrend":0.1027,"trendLCI":0.0326,"trendUCI":0.1743,"trendMedian":0.1047,"trendStatSig":true,"trendPropInSupport":0.9996,"trendYears":"1989-2023"},{"trendSpecies":"LEFL","trendGuild":"Invertebrate","trendTrend":0.0818,"trendLCI":-0.2508,"trendUCI":0.3708,"trendMedian":0.1426,"trendStatSig":false,"trendPropInSupport":0.6321,"trendYears":"1989-2023"},{"trendSpecies":"MAWA","trendGuild":"Invertebrate","trendTrend":-0.1346,"trendLCI":-0.3782,"trendUCI":0.0356,"trendMedian":-0.1261,"trendStatSig":false,"trendPropInSupport":0.9271,"trendYears":"1989-2023"},{"trendSpecies":"MODO","trendGuild":"PlantSeed","trendTrend":-0.029,"trendLCI":-0.1412,"trendUCI":0.0619,"trendMedian":-0.0244,"trendStatSig":false,"trendPropInSupport":0.68,"trendYears":"1989-2023"},{"trendSpecies":"MOWA","trendGuild":"Invertebrate","trendTrend":-0.1903,"trendLCI":-0.5119,"trendUCI":0.1547,"trendMedian":-0.1978,"trendStatSig":false,"trendPropInSupport":0.8517,"trendYears":"1989-2023"},{"trendSpecies":"MYWA","trendGuild":"Invertebrate","trendTrend":0.0126,"trendLCI":-0.1335,"trendUCI":0.1434,"trendMedian":0.0143,"trendStatSig":false,"trendPropInSupport":0.5888,"trendYears":"1989-2023"},{"trendSpecies":"NAWA","trendGuild":"Invertebrate","trendTrend":-0.3075,"trendLCI":-0.5649,"trendUCI":-0.0626,"trendMedian":-0.3027,"trendStatSig":true,"trendPropInSupport":0.9946,"trendYears":"1989-2023"},{"trendSpecies":"NOPA","trendGuild":"Invertebrate","trendTrend":-0.0945,"trendLCI":-0.3136,"trendUCI":0.0896,"trendMedian":-0.0943,"trendStatSig":false,"trendPropInSupport":0.8104,"trendYears":"1989-2023"},{"trendSpecies":"NOWA","trendGuild":"Invertebrate","trendTrend":-0.0858,"trendLCI":-0.2606,"trendUCI":0.0862,"trendMedian":-0.0866,"trendStatSig":false,"trendPropInSupport":0.82,"trendYears":"1989-2023"},{"trendSpecies":"OVEN","trendGuild":"Invertebrate","trendTrend":0.0526,"trendLCI":-0.0067,"trendUCI":0.1345,"trendMedian":0.0489,"trendStatSig":false,"trendPropInSupport":0.9529,"trendYears":"1989-2023"},{"trendSpecies":"PIWO","trendGuild":"Invertebrate","trendTrend":-0.0167,"trendLCI":-0.1296,"trendUCI":0.0911,"trendMedian":-0.018,"trendStatSig":false,"trendPropInSupport":0.5921,"trendYears":"1989-2023"},{"trendSpecies":"PUFI","trendGuild":"PlantSeed","trendTrend":-0.2543,"trendLCI":-0.4626,"trendUCI":-0.0586,"trendMedian":-0.2473,"trendStatSig":true,"trendPropInSupport":0.9958,"trendYears":"1989-2023"},{"trendSpecies":"RBGR","trendGuild":"Omnivore","trendTrend":0.0449,"trendLCI":-0.0226,"trendUCI":0.1123,"trendMedian":0.0451,"trendStatSig":false,"trendPropInSupport":0.9,"trendYears":"1989-2023"},{"trendSpecies":"RBNU","trendGuild":"Omnivore","trendTrend":-0.0861,"trendLCI":-0.2278,"trendUCI":0.0619,"trendMedian":-0.0889,"trendStatSig":false,"trendPropInSupport":0.8717,"trendYears":"1989-2023"},{"trendSpecies":"RBWO","trendGuild":"Omnivore","trendTrend":-0.1266,"trendLCI":-0.349,"trendUCI":0.0908,"trendMedian":-0.1246,"trendStatSig":false,"trendPropInSupport":0.8775,"trendYears":"1989-2023"},{"trendSpecies":"RESQ","trendGuild":"Omnivore","trendTrend":-0.1858,"trendLCI":-0.386,"trendUCI":-0.0092,"trendMedian":-0.1747,"trendStatSig":true,"trendPropInSupport":0.9812,"trendYears":"1989-2023"},{"trendSpecies":"REVI","trendGuild":"Invertebrate","trendTrend":0.125,"trendLCI":0.0565,"trendUCI":0.1908,"trendMedian":0.1264,"trendStatSig":true,"trendPropInSupport":1,"trendYears":"1989-2023"},{"trendSpecies":"RWBL","trendGuild":"Omnivore","trendTrend":-0.1453,"trendLCI":-0.4224,"trendUCI":0.1171,"trendMedian":-0.14,"trendStatSig":false,"trendPropInSupport":0.8192,"trendYears":"1989-2023"},{"trendSpecies":"SCJU","trendGuild":"PlantSeed","trendTrend":-0.0265,"trendLCI":-0.137,"trendUCI":0.0859,"trendMedian":-0.0295,"trendStatSig":false,"trendPropInSupport":0.6729,"trendYears":"1989-2023"},{"trendSpecies":"SCTA","trendGuild":"Invertebrate","trendTrend":0.037,"trendLCI":-0.0717,"trendUCI":0.1234,"trendMedian":0.0548,"trendStatSig":false,"trendPropInSupport":0.6829,"trendYears":"1989-2023"},{"trendSpecies":"SOSP","trendGuild":"Omnivore","trendTrend":-0.2325,"trendLCI":-0.585,"trendUCI":0.0837,"trendMedian":-0.2215,"trendStatSig":false,"trendPropInSupport":0.9042,"trendYears":"1989-2023"},{"trendSpecies":"SWSP","trendGuild":"Omnivore","trendTrend":-0.0397,"trendLCI":-0.4144,"trendUCI":0.2701,"trendMedian":-0.0286,"trendStatSig":false,"trendPropInSupport":0.555,"trendYears":"1989-2023"},{"trendSpecies":"SWTH","trendGuild":"Invertebrate","trendTrend":-0.0848,"trendLCI":-0.2631,"trendUCI":0.0909,"trendMedian":-0.0858,"trendStatSig":false,"trendPropInSupport":0.8133,"trendYears":"1989-2023"},{"trendSpecies":"TUTI","trendGuild":"Invertebrate","trendTrend":-0.1087,"trendLCI":-0.2394,"trendUCI":0.0431,"trendMedian":-0.113,"trendStatSig":false,"trendPropInSupport":0.9171,"trendYears":"1989-2023"},{"trendSpecies":"VEER","trendGuild":"Omnivore","trendTrend":-0.0335,"trendLCI":-0.1354,"trendUCI":0.0554,"trendMedian":-0.0278,"trendStatSig":false,"trendPropInSupport":0.7,"trendYears":"1989-2023"},{"trendSpecies":"WBNU","trendGuild":"Omnivore","trendTrend":0.0437,"trendLCI":-0.0335,"trendUCI":0.1176,"trendMedian":0.0445,"trendStatSig":false,"trendPropInSupport":0.8488,"trendYears":"1989-2023"},{"trendSpecies":"WIWR","trendGuild":"Invertebrate","trendTrend":0.0584,"trendLCI":-0.0124,"trendUCI":0.1199,"trendMedian":0.0594,"trendStatSig":false,"trendPropInSupport":0.9542,"trendYears":"1989-2023"},{"trendSpecies":"WOTH","trendGuild":"Invertebrate","trendTrend":-0.0294,"trendLCI":-0.128,"trendUCI":0.0784,"trendMedian":-0.0323,"trendStatSig":false,"trendPropInSupport":0.7025,"trendYears":"1989-2023"},{"trendSpecies":"WTSP","trendGuild":"PlantSeed","trendTrend":-0.0599,"trendLCI":-0.293,"trendUCI":0.1329,"trendMedian":-0.0623,"trendStatSig":false,"trendPropInSupport":0.6833,"trendYears":"1989-2023"},{"trendSpecies":"YBFL","trendGuild":"Invertebrate","trendTrend":-0.1166,"trendLCI":-0.4084,"trendUCI":0.1414,"trendMedian":-0.1091,"trendStatSig":false,"trendPropInSupport":0.8079,"trendYears":"1989-2023"},{"trendSpecies":"YBSA","trendGuild":"Omnivore","trendTrend":0.052,"trendLCI":-0.0048,"trendUCI":0.1117,"trendMedian":0.0514,"trendStatSig":false,"trendPropInSupport":0.9588,"trendYears":"1989-2023"},{"trendSpecies":"YEWA","trendGuild":"Invertebrate","trendTrend":-0.2926,"trendLCI":-0.6532,"trendUCI":-0.0154,"trendMedian":-0.2803,"trendStatSig":true,"trendPropInSupport":0.9788,"trendYears":"1989-2023"},{"trendSpecies":"YSFL","trendGuild":"Invertebrate","trendTrend":-0.2697,"trendLCI":-0.462,"trendUCI":-0.072,"trendMedian":-0.2734,"trendStatSig":true,"trendPropInSupport":0.9975,"trendYears":"1989-2023"},{"trendSpecies":"YTVI","trendGuild":"Invertebrate","trendTrend":-0.1675,"trendLCI":-0.432,"trendUCI":0.0813,"trendMedian":-0.1592,"trendStatSig":false,"trendPropInSupport":0.9108,"trendYears":"1989-2023"}] 

let trendSummary

// Set up the SVG dimensions

var ordTrendElement_info = document.getElementById('orderedTrends_div');
var ordTrend_positionInfo = ordTrendElement_info.getBoundingClientRect();

// Set up the SVG dimensions
var td_width = ordTrend_positionInfo.width;
var td_height = ordTrend_positionInfo.height;

// Set up the margins
var td_margin = { top: td_height*0.05,
               bottom: td_height*0.05,
               right: td_width*0.05,  
               left: td_width*0.05 };

// Calculate the inner dimensions of the plot
var td_innerWidth = td_width - (td_margin.left + td_margin.right);
var td_innerHeight = td_height - (td_margin.top + td_margin.bottom);

// apicall
const fetchPromise = fetch("http://vtatlasoflife.org:4321/trends")
                     .then(function(response){ return response.json()});

//resolve the promise then print
Promise.resolve(fetchPromise) // Waits for fetchPromise to get its value
.then(function (res){
             trendSummary = res.rows;
             /*
             trendSummary.trendSpecies = res.rows.map(d => d.trendSpecies);
             trendSummary.trendGuild = res.rows.map(d => d.trendGuild);
             trendSummary.trendTrend = res.rows.map(d => d.trendTrend);
             trendSummary.trendLCI = res.rows.map(d => d.trendLCI);
             trendSummary.trendUCI = res.rows.map(d => d.trendUCI);
             trendSummary.trendMedian = res.rows.map(d => d.trendMedian);
             trendSummary.trendStatSig = res.rows.map(d => d.trendStatSig);
             trendSummary.trendPropInSupport = res.rows.map(d => d.trendPropInSupport);
             trendSummary.trendYears = res.rows.map(d => d.trendYears)
            */
            })
.then(() => {

var trendEst = trendSummary.map(a => a.trendTrend);
var trendSpp = trendSummary.map(a => a.trendSpecies);

/*
console.log(trendSummary[0]);
console.log(trendEst); 
console.log(trendSpp);
console.log('We got here bro');
*/

// Create the SVG container
var svg = d3.select("#orderedTrends")
  .append("svg")
  .attr("width", td_width)
  .attr("height", td_height)
  .append("g")
  .attr("transform", "translate(" + td_margin.left + "," + td_margin.top + ")");

  console.log(d3.range(trendSummary.length))
// Set up the scales
var xScale = d3.scaleBand()
  .domain(d3.range(trendSummary.length))
  .range([td_margin.left, td_innerWidth]);

var yScale = d3.scaleLinear()
  .domain([d3.min(trendSummary.map(d => d.trendLCI)), d3.max(trendSummary.map(d => d.trendUCI))])
  .range([td_innerHeight, td_margin.top]);

  // Create the circle that travels along the curve of chart
  var focus = svg
  .append('g')
  .append('circle')
    .style("fill", "none")
    .attr("stroke", "black")
    .attr('r', 8.5)
    .style("opacity", 0)

// Create the text that travels along the curve of chart
var focusText = svg
  .append('g')
  .append('text')
    .style("opacity", 0)
    .style("font-size", "20px")
    .style("white-space","pre-line")
    .attr("text-anchor", "left")
    .attr("alignment-baseline", "middle")

var focusDrop = svg
      .append('line')
      .attr("x1", xScale(0))
      .attr("x2", xScale(0))
      .attr("y1", yScale(0))
      .attr("y2", yScale(0))
      .attr("stroke",'gray')
      .style("opacity",0)
// Plot the segments
svg.selectAll("line")
  .data(trendSummary)
  .enter().append("line")
  .attr("x1", (d, i) => xScale(i))
  .attr("x2", (d, i) => xScale(i))
  .attr("y1", d => yScale(d.trendLCI))
  .attr("y2", d => yScale(d.trendUCI))
  .attr("stroke", "gray");  

  // Plot the points
svg.selectAll("circle")
.data(trendSummary)
.enter().append("circle")
.attr("cx", (d, i) => xScale(i))
.attr("cy", d => yScale(d.trendTrend))
.attr("r", 4.5)
.attr("fill", d => d.trendTrend < 0 ? "red" : "blue")
.attr("opacity", d => d.trendStatSig ? "1" : "0.5")
.attr("stroke", d => d.trendStatSig ? "black" : "gray")
.on('mouseover', mouseover)
.on('mousemove', mousemove)
.on('mouseout', mouseout)
.on('click', clickon);

// What happens when the mouse move -> show the annotations at the right positions.
function mouseover() {
    focus.style("opacity", 1)
    focusText.style("opacity",1)
             .style("font-size","18px")
             .style("white-space","pre-line")
    focusDrop.style("opacity",0.75)
  }

function mousemove(event) {
  // recover coordinate we need
  var y0 = yScale.invert(d3.pointer(event)[1]);
  var i = d3.bisectLeft(trendEst,y0);

  console.log('i=: '+i)

  var selectedData = trendSummary[i]
  console.log(selectedData)
  focus
    .attr("cx", xScale(i))
    .attr("cy", yScale(selectedData.trendTrend))
  focusText
    .html(selectedData.trendSpecies)
    .style("font-size","18px")
    .style("font-weight","bold")
    .attr("x", xScale(i) + 15)
    .attr("y", yScale(selectedData.trendTrend)-25)
  focusDrop
    .attr("x1", xScale(0))
    .attr("x2", xScale(0))
    .attr("y1", yScale(0))
    .attr("y2", yScale(0))

  }
function mouseout() {
  focus.style("opacity", 0)
  focusText.style("opacity", 0)
  focusDrop.style("opacity",0)
}

/* Attempt to add on click to this plot 
   that will provide the species name 
   and bring you to the state trend 
*/

function clickon() {
  // recover coordinate we need
  var sppSelect = d3.select(this).data()[0].trendSpecies;
  console.log("Congratulations! You've selected: " + sppSelect);
  }
 
// Draw the horizontal dashed line
svg.append("line")
  .attr("x1", xScale(0))
  .attr("x2", td_innerWidth)
  .attr("y1", yScale(0))
  .attr("y2", yScale(0))
  .attr("stroke", "gray")
  .attr("stroke-dasharray", "4");

// Draw y-axis
svg.append('g')
    .attr('transform', `translate(${td_margin.left-10})`)
    .call(d3.axisLeft(yScale));

svg.append("text")
        .attr("class", "y label")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - (td_margin.left/2))
        .attr("x",0 - (td_innerHeight / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Trend");
});

/*var imgs = svg
            .append("svg:image")
            .attr("xlink:href", "https://vtecostudies.org/wp-content/uploads/2014/08/eastern-wood-pewee.jpg")
                .attr("x", width - 200)
                .attr("y", 200)
                .attr("width", "200")
                .attr("height", "425");*/